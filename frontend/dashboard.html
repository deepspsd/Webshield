<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - WebShield</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);color:#fff}
    .bubble{position:absolute;border-radius:50%;opacity:.15;animation:float 12s infinite ease-in-out}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-60px)}}
  </style>
</head>
<body class="relative overflow-x-hidden">
  <!-- decorative bubbles -->
  <div class="bubble w-72 h-72 bg-cyan-400 top-20 left-20 blur-3xl"></div>
  <div class="bubble w-96 h-96 bg-purple-500 bottom-20 right-20 blur-3xl"></div>

  <!-- nav -->
  <nav class="bg-slate-900/50 backdrop-blur-xl px-6 py-4 shadow-lg flex justify-between items-center">
    <a href="dashboard.html" class="flex items-center gap-2">
      <span class="w-8 h-8 bg-cyan-400 rounded-full flex items-center justify-center text-xl">ğŸ›¡ï¸</span>
      <span class="text-2xl font-bold text-cyan-400">WebShield</span>
    </a>
    <div class="space-x-6 text-sm">
      <a href="community_alerts.html" class="hover:text-white">Community alerts</a>
      <a href="history.html" class="hover:text-white">History</a>
      <a href="profile.html" class="hover:text-white">Profile</a>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-6 py-12 space-y-10">

    <!-- Welcome -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h2 class="text-xl font-semibold text-cyan-300">Welcome back, <span id="userEmail">User</span>!</h2>
      <p class="text-gray-400 text-sm mt-1">Ready to check any URL for threats.</p>
    </div>

    <!-- URL Scanner -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-cyan-300 mb-4">ğŸ” URL Threat Scanner</h3>
      <div class="mb-4 p-4 bg-slate-900 rounded-xl border-2 border-cyan-500 flex flex-col sm:flex-row items-center gap-4">
        <label for="urlInput" class="text-cyan-300 font-semibold mr-2">Enter URL to scan:</label>
        <form id="urlForm" class="flex-1 flex flex-col sm:flex-row gap-4 w-full">
          <input id="urlInput" type="text" placeholder="https://example.com"
                 class="flex-1 px-4 py-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:ring-2 focus:ring-cyan-400 text-lg" required/>
          <button type="submit"
                  class="bg-cyan-500 hover:bg-cyan-600 px-8 py-2 rounded-lg text-white font-bold text-lg transition">
            Scan URL
          </button>
        </form>
      </div>
      <div id="errorBox" class="mb-4 text-red-400 hidden"></div>
      <div id="resultBox" class="mt-4 hidden"></div>
    </div>

    <!-- Report -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-red-300 mb-2">ğŸš© Report Suspicious Website</h3>
      <p class="text-gray-400 text-sm mb-4">Help othersâ€”submit any malicious URL you encounter.</p>
      <a href="report.html" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold transition">
        + Report Website
      </a>
    </div>

    <!-- Quick Safety Tips -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-green-300 mb-4">âš¡ Quick Safety Tips</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-slate-900/50 p-3 rounded-lg">
          <h4 class="text-cyan-400 font-semibold mb-2">ğŸ”’ SSL Check</h4>
          <p class="text-gray-300 text-sm">Always verify HTTPS and padlock icon before entering data</p>
        </div>
        <div class="bg-slate-900/50 p-3 rounded-lg">
          <h4 class="text-red-400 font-semibold mb-2">ğŸ£ Phishing Signs</h4>
          <p class="text-gray-300 text-sm">Watch for typosquatted domains and urgent language</p>
        </div>
        <div class="bg-slate-900/50 p-3 rounded-lg">
          <h4 class="text-yellow-400 font-semibold mb-2">ğŸ” URL Analysis</h4>
          <p class="text-gray-300 text-sm">Check for suspicious subdomains and random strings</p>
        </div>
        <div class="bg-slate-900/50 p-3 rounded-lg">
          <h4 class="text-purple-400 font-semibold mb-2">ğŸ“„ Content Check</h4>
          <p class="text-gray-300 text-sm">Look for professional design and contact information</p>
        </div>
      </div>
      <div class="mt-4 text-center">
        <a href="community_alerts.html" class="text-cyan-400 hover:underline text-sm">View detailed safety guidelines â†’</a>
      </div>
    </div>

    <!-- Safety Tips -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-cyan-300 mb-4">ğŸ›¡ï¸ Web Safety Tips</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- SSL & Security -->
        <div class="bg-slate-900/50 p-4 rounded-lg border border-cyan-500/20">
          <h4 class="text-cyan-400 font-semibold mb-3">ğŸ”’ SSL & Security Verification</h4>
          <ul class="text-gray-300 text-sm space-y-2">
            <li>âœ… Always check for HTTPS and padlock icon</li>
            <li>âœ… Verify SSL certificate validity</li>
            <li>âœ… Look for "Secure" in the address bar</li>
            <li>âœ… Check certificate issuer authenticity</li>
            <li>âš ï¸ Avoid sites with SSL warnings</li>
          </ul>
        </div>
        
        <!-- Phishing Detection -->
        <div class="bg-slate-900/50 p-4 rounded-lg border border-red-500/20">
          <h4 class="text-red-400 font-semibold mb-3">ğŸ£ Phishing Score Indicators</h4>
          <ul class="text-gray-300 text-sm space-y-2">
            <li>ğŸ” Check for suspicious URL patterns</li>
            <li>ğŸ” Look for typosquatted domains</li>
            <li>ğŸ” Verify sender email addresses</li>
            <li>ğŸ” Check for urgent/emotional language</li>
            <li>ğŸ” Verify payment/credit card forms</li>
          </ul>
        </div>
        
        <!-- URL Analysis -->
        <div class="bg-slate-900/50 p-4 rounded-lg border border-yellow-500/20">
          <h4 class="text-yellow-400 font-semibold mb-3">ğŸ” URL Pattern Analysis</h4>
          <ul class="text-gray-300 text-sm space-y-2">
            <li>ğŸ” Check for suspicious subdomains</li>
            <li>ğŸ” Look for random character strings</li>
            <li>ğŸ” Verify domain age and reputation</li>
            <li>ğŸ” Check for redirect chains</li>
            <li>ğŸ” Analyze URL structure patterns</li>
          </ul>
        </div>
        
        <!-- Content Analysis -->
        <div class="bg-slate-900/50 p-4 rounded-lg border border-purple-500/20">
          <h4 class="text-purple-400 font-semibold mb-3">ğŸ“„ Content Analysis Tips</h4>
          <ul class="text-gray-300 text-sm space-y-2">
            <li>ğŸ“ Check for spelling/grammar errors</li>
            <li>ğŸ“ Look for generic content</li>
            <li>ğŸ“ Verify contact information</li>
            <li>ğŸ“ Check for professional design</li>
            <li>ğŸ“ Analyze page loading behavior</li>
          </ul>
        </div>
      </div>
      
      <!-- Quick Safety Checklist -->
      <div class="mt-6 bg-slate-900/50 p-4 rounded-lg border border-green-500/20">
        <h4 class="text-green-400 font-semibold mb-3">âœ… Quick Safety Checklist</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
          <div class="flex items-center space-x-2">
            <span class="text-green-400">âœ“</span>
            <span class="text-gray-300">HTTPS present</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">âœ“</span>
            <span class="text-gray-300">Domain looks legitimate</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">âœ“</span>
            <span class="text-gray-300">No urgent requests</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">âœ“</span>
            <span class="text-gray-300">Professional design</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">âœ“</span>
            <span class="text-gray-300">Contact info available</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">âœ“</span>
            <span class="text-gray-300">No suspicious redirects</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-400 border-t border-slate-700 mt-12 py-4">
    Â© 2025 WebShield Â· <a href="#" class="hover:underline">Help</a> Â· <a href="#" class="hover:underline">Privacy</a>
  </footer>

  <!-- JS -->
  <script>
    const BACKEND_URL = '/api';

    // Set user name in welcome message
    const userName = localStorage.getItem('user_name');
    const userEmail = localStorage.getItem('user_email');
    const welcomeName = userName && userName.trim() ? userName : (userEmail || 'User');
    document.getElementById('userEmail').textContent = welcomeName;

    document.getElementById('urlForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Prevent multiple submissions
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = 'Scanning...';
      
      let url = document.getElementById('urlInput').value.trim();
      const errorBox = document.getElementById('errorBox');
      const resultBox = document.getElementById('resultBox');
      errorBox.classList.add('hidden');
      resultBox.classList.remove('hidden');
      resultBox.innerHTML = '<span class="text-cyan-400">ğŸ”„ Initializing scan...</span>';
      // Prepend https:// if missing
      if (url && !/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }
      // Improved URL validation
      const urlPattern = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?$/i;
      if (!url || !urlPattern.test(url)) {
        errorBox.textContent = 'Please enter a valid URL (e.g., https://example.com).';
        errorBox.classList.remove('hidden');
        resultBox.classList.add('hidden');
        return;
      }
      try {
        const res = await fetch(`${BACKEND_URL}/scan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Scan failed');
        
                 // Show scanning status
         resultBox.innerHTML = '<span class="text-cyan-400">âš¡ Scanning in progress...</span>';
        
        // Poll for results
        if (data.scan_id) {
                     let attempts = 0;
           const maxAttempts = 150; // 150 attempts (120 seconds max for dev tunnels)
          
          const pollResults = async () => {
            try {
              const resultRes = await fetch(`${BACKEND_URL}/scan/${data.scan_id}`);
              const resultData = await resultRes.json();
              
              if (resultData.status === 'completed' && resultData.results) {
                // Redirect to scan result page
                window.location.href = `scan_result.html?scan_id=${encodeURIComponent(data.scan_id)}`;
                return;
              } else if (resultData.status === 'error') {
                throw new Error('Scan failed');
              } else {
                // Still processing, continue polling
                attempts++;
                if (attempts < maxAttempts) {
                  setTimeout(pollResults, 200); // Poll every 200ms for dev tunnels
                } else {
                  throw new Error('Scan timeout - please try again');
                }
              }
            } catch (err) {
              errorBox.textContent = err.message || 'Failed to get scan results';
              errorBox.classList.remove('hidden');
              resultBox.classList.add('hidden');
            }
          };
          
          // Start polling after 2 seconds
          setTimeout(pollResults, 2000);
        } else {
          // fallback: show result inline if scan_id missing
          const { results } = data;
          const safe = !results.is_malicious;
          const color = safe ? 'text-green-400' : results.threat_level === 'high' ? 'text-red-400' : 'text-yellow-400';
          resultBox.innerHTML = `
            <div class="${color} font-semibold text-lg">
              ${safe ? 'âœ… Safe' : `âš ï¸ ${results.threat_level.toUpperCase()} RISK`}
            </div>
            <div class="text-sm text-gray-300 mt-2">
              Malicious engines: ${results.malicious_count}/${results.total_engines}<br>
              SSL: ${results.ssl_valid ? 'Valid' : 'Invalid'}
            </div>
          `;
        }
      } catch (err) {
        errorBox.textContent = err.message || 'Scan error';
        errorBox.classList.remove('hidden');
        resultBox.classList.add('hidden');
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });
  </script>
</body>
</html>
