<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - WebShield</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);color:#fff}
    .bubble{position:absolute;border-radius:50%;opacity:.15;animation:float 12s infinite ease-in-out}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-60px)}}
  </style>
</head>
<body class="relative overflow-x-hidden">
  <!-- decorative bubbles -->
  <div class="bubble w-72 h-72 bg-cyan-400 top-20 left-20 blur-3xl"></div>
  <div class="bubble w-96 h-96 bg-purple-500 bottom-20 right-20 blur-3xl"></div>

  <!-- nav -->
  <nav class="bg-slate-900/50 backdrop-blur-xl px-6 py-4 shadow-lg flex justify-between items-center">
    <a href="dashboard.html" class="flex items-center gap-2">
      <span class="w-8 h-8 bg-cyan-400 rounded-full flex items-center justify-center text-xl">üõ°Ô∏è</span>
      <span class="text-2xl font-bold text-cyan-400">WebShield</span>
    </a>
    <div class="space-x-6 text-sm">
      <a href="community_alerts.html" class="hover:text-white">Community alerts</a>
      <a href="history.html" class="hover:text-white">History</a>
      <a href="profile.html" class="hover:text-white">Profile</a>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-6 py-12 space-y-10">

    <!-- Welcome -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h2 class="text-xl font-semibold text-cyan-300">Welcome back, <span id="userEmail">User</span>!</h2>
      <p class="text-gray-400 text-sm mt-1">Ready to check any URL for threats.</p>
    </div>

    <!-- URL Scanner -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-cyan-300 mb-4">üîç URL Threat Scanner</h3>
      <div class="mb-4 p-4 bg-slate-900 rounded-xl border-2 border-cyan-500 flex flex-col sm:flex-row items-center gap-4">
        <label for="urlInput" class="text-cyan-300 font-semibold mr-2">Enter URL to scan:</label>
        <form id="urlForm" class="flex-1 flex flex-col sm:flex-row gap-4 w-full">
          <input id="urlInput" type="text" placeholder="https://example.com"
                 class="flex-1 px-4 py-2 rounded-lg bg-slate-700 text-white border border-slate-600 focus:ring-2 focus:ring-cyan-400 text-lg" required/>
          <button type="submit"
                  class="bg-cyan-500 hover:bg-cyan-600 px-8 py-2 rounded-lg text-white font-bold text-lg transition">
            Scan URL
          </button>
        </form>
      </div>
      <div id="errorBox" class="mb-4 text-red-400 hidden"></div>
      <div id="resultBox" class="mt-4 hidden"></div>
    </div>

    <!-- Report -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-red-300 mb-2">üö© Report Suspicious Website</h3>
      <p class="text-gray-400 text-sm mb-4">Help others‚Äîsubmit any malicious URL you encounter.</p>
      <a href="report.html" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold transition">
        + Report Website
      </a>
    </div>

    <!-- Safety Tips -->
    <div class="bg-slate-800/50 backdrop-blur-xl p-6 rounded-xl">
      <h3 class="text-xl font-semibold text-cyan-300 mb-2">üõ°Ô∏è Web Safety Tips</h3>
      <ul class="list-disc list-inside text-gray-300 text-sm space-y-1">
        <li>Always verify HTTPS and the padlock icon.</li>
        <li>Watch for typosquatted domains.</li>
        <li>Avoid links in unsolicited emails.</li>
        <li>Use unique passwords everywhere.</li>
      </ul>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-400 border-t border-slate-700 mt-12 py-4">
    ¬© 2025 WebShield ¬∑ <a href="#" class="hover:underline">Help</a> ¬∑ <a href="#" class="hover:underline">Privacy</a>
  </footer>

  <!-- JS -->
  <script>
    const BACKEND_URL = '/api';

    // Set user name in welcome message
    const userName = localStorage.getItem('user_name');
    const userEmail = localStorage.getItem('user_email');
    const welcomeName = userName && userName.trim() ? userName : (userEmail || 'User');
    document.getElementById('userEmail').textContent = welcomeName;

    document.getElementById('urlForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      let url = document.getElementById('urlInput').value.trim();
      const errorBox = document.getElementById('errorBox');
      const resultBox = document.getElementById('resultBox');
      errorBox.classList.add('hidden');
      resultBox.classList.remove('hidden');
      resultBox.innerHTML = '<span class="text-gray-400">Scanning‚Ä¶</span>';
      // Prepend https:// if missing
      if (url && !/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }
      // Improved URL validation
      const urlPattern = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?$/i;
      if (!url || !urlPattern.test(url)) {
        errorBox.textContent = 'Please enter a valid URL (e.g., https://example.com).';
        errorBox.classList.remove('hidden');
        resultBox.classList.add('hidden');
        return;
      }
      try {
        const res = await fetch(`${BACKEND_URL}/scan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Scan failed');
        // Redirect to scan result page with scan_id
        if (data.scan_id) {
          window.location.href = `scan_result.html?scan_id=${encodeURIComponent(data.scan_id)}`;
          return;
        }
        // fallback: show result inline if scan_id missing
        const { results } = data;
        const safe = !results.is_malicious;
        const color = safe ? 'text-green-400' : results.threat_level === 'high' ? 'text-red-400' : 'text-yellow-400';
        resultBox.innerHTML = `
          <div class="${color} font-semibold text-lg">
            ${safe ? '‚úÖ Safe' : `‚ö†Ô∏è ${results.threat_level.toUpperCase()} RISK`}
          </div>
          <div class="text-sm text-gray-300 mt-2">
            Malicious engines: ${results.malicious_count}/${results.total_engines}<br>
            SSL: ${results.ssl_valid ? 'Valid' : 'Invalid'}
          </div>
        `;
      } catch (err) {
        errorBox.textContent = err.message || 'Scan error';
        errorBox.classList.remove('hidden');
        resultBox.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
